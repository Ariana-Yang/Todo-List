<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- 设置文档字符集和视口，确保在移动设备上正确显示 -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 页面标题，显示在浏览器标签上 -->
    <title>我的待办清单</title>
    <style>
        /* 重置浏览器默认样式，确保跨浏览器一致性 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* 页面整体样式 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8fafc;
            color: #333;
            line-height: 1.6;
        }

        /* 主容器，限制最大宽度并居中显示 */
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }

        /* 页面标题样式 */
        h1 {
            text-align: center;
            color: #3b82f6; /* 主色调：明亮蓝色 */
            font-size: 28px;
            margin-bottom: 30px;
            font-weight: 600;
        }

        /* 输入区域样式，使用flex布局使输入框和按钮水平排列 */
        .input-area {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 25px;
        }
        
        /* 输入框和字符计数容器 */
        .input-container {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }
        
        /* 字符计数样式 */
        .char-count {
            font-size: 14px;
            color: #6b7280;
            text-align: right;
            margin-top: -4px;
            transition: color 0.2s ease;
        }
        
        /* 字符计数超过限制时的样式 */
        .char-count.limit-reached {
            color: #ef4444;
            font-weight: 500;
        }

        /* 输入框样式 */
        .task-input {
            flex: 1; /* 输入框占据剩余空间 */
            padding: 12px 16px;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s ease;
        }

        /* 输入框聚焦时的样式变化 */
        .task-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* 添加按钮样式 */
        .add-btn {
            padding: 12px 24px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            white-space: nowrap;
        }

        /* 添加按钮悬停效果 */
        .add-btn:hover {
            background-color: #2563eb;
        }

        /* 任务列表容器 */
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* 单个任务项样式 */
        .task-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: transform 0.1s ease, box-shadow 0.2s ease;
            border-bottom: 1px solid #e5e7eb;
        }

        /* 任务项悬停效果 */
        .task-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* 过期任务样式 */
        .task-item.overdue {
            background-color: #FFF1F0;
            border-left: 4px solid #FF4D4F;
        }
        
        /* 截止日期显示样式 */
        .deadline-display {
            font-size: 12px;
            color: #6b7280;
            margin-left: 8px;
        }
        
        /* 过期截止日期样式 */
        .deadline-display.overdue {
            color: #FF4D4F;
            font-weight: 500;
        }
        
        /* 拖拽相关样式 */
        .task-item {
            cursor: move;
            user-select: none;
        }
        
        /* 拖拽过程中的任务项样式 */
        .task-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        
        /* 拖拽占位符样式 */
        .task-placeholder {
            height: 60px;
            background-color: #F0F9FF;
            border: 2px dashed #3B82F6;
            border-radius: 8px;
            margin: 12px 0;
        }
        
        /* 功能按钮区域样式 */
        .function-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* 导出功能样式 */
        .export-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        /* 导出选择器样式 */
        .export-select {
            padding: 8px 12px;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
            outline: none;
            transition: border-color 0.2s ease;
        }
        
        /* 导出选择器聚焦效果 */
        .export-select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* 导出按钮样式 */
        .export-btn {
            padding: 8px 16px;
            background-color: #6366f1;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        /* 导出按钮悬停效果 */
        .export-btn:hover {
            background-color: #4f46e5;
        }
        
        /* 统计区域样式 */
        .stats-area {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }
        
        /* 统计区域标题样式 */
        .stats-area h2 {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }
        
        /* 统计卡片容器样式 */
        .stats-cards {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        /* 统计卡片样式 */
        .stat-card {
            background-color: #f8fafc;
            padding: 15px 20px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
            min-width: 120px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        /* 统计卡片标题样式 */
        .stat-title {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
        }
        
        /* 统计卡片数值样式 */
        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #3b82f6;
        }
        
        /* 图表区域样式 */
        .chart-area {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Canvas样式 */
        #weeklyChart {
            max-width: 100%;
            height: auto;
        }

        /* 任务内容样式 */
        .task-content {
            flex: 1;
            font-size: 16px;
            color: #333;
            margin-right: 16px;
            word-wrap: break-word;
            word-break: break-word;
        }

        /* 任务按钮容器 */
        .task-buttons {
            display: flex;
            gap: 8px;
        }

        /* 完成按钮样式 */
        .complete-btn {
            padding: 8px 16px;
            background-color: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        /* 完成按钮悬停效果 */
        .complete-btn:hover {
            background-color: #059669;
        }

        /* 删除按钮样式 */
        .delete-btn {
            padding: 8px 16px;
            background-color: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        /* 删除按钮悬停效果 */
        .delete-btn:hover {
            background-color: #dc2626;
        }
        
        /* 编辑按钮样式 */
        .edit-btn {
            padding: 8px 16px;
            background-color: #6b7280;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        /* 编辑按钮悬停效果 */
        .edit-btn:hover {
            background-color: #4b5563;
        }
        
        /* 编辑模式容器样式 */
        .task-edit-mode {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        /* 编辑模式输入框样式 */
        .edit-input {
            padding: 12px 16px;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            font-size: 16px;
            outline: none;
        }
        
        /* 编辑模式选择器样式 */
        .edit-select {
            padding: 8px 12px;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
            outline: none;
        }
        
        /* 编辑模式选项组样式 */
        .edit-options {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        /* 编辑模式按钮组样式 */
        .edit-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        /* 保存按钮样式 */
        .save-btn {
            padding: 8px 16px;
            background-color: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        /* 保存按钮悬停效果 */
        .save-btn:hover {
            background-color: #059669;
        }
        
        /* 取消编辑按钮样式 */
        .cancel-edit-btn {
            padding: 8px 16px;
            background-color: #6b7280;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        /* 取消编辑按钮悬停效果 */
        .cancel-edit-btn:hover {
            background-color: #4b5563;
        }

        /* 清空已完成任务按钮容器 */
        .clear-completed {
            margin-top: 20px;
            display: flex;
            justify-content: center;
        }

        /* 清空已完成按钮样式 */
        .clear-btn {
            padding: 10px 20px;
            background-color: #f3f4f6;
            color: #6b7280;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 1;
            visibility: visible;
        }

        /* 清空已完成按钮悬停效果 */
        .clear-btn:hover {
            background-color: #e5e7eb;
            color: #374151;
        }

        /* 隐藏清空已完成按钮的样式 */
        .clear-btn.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        /* 搜索区域样式 */
        .search-area {
            margin-bottom: 15px;
        }

        /* 搜索输入框样式 */
        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s ease;
        }

        /* 搜索输入框聚焦效果 */
        .search-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* 分类筛选区域样式 */
        .filter-area {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        /* 筛选标签样式 */
        .filter-label {
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            white-space: nowrap;
        }

        /* 筛选选项容器样式 */
        .filter-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* 筛选按钮样式 */
        .filter-btn {
            padding: 8px 16px;
            background-color: #f3f4f6;
            color: #6b7280;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        /* 筛选按钮悬停效果 */
        .filter-btn:hover {
            background-color: #e5e7eb;
            color: #374151;
        }

        /* 筛选按钮激活状态 */
        .filter-btn.active {
            background-color: var(--category-color, #3b82f6);
            color: white;
            border-color: var(--category-color, #3b82f6);
        }

        /* 任务选项容器样式 */
        .task-options {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* 选项组样式 */
        .option-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* 选项标签样式 */
        .option-group label {
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
        }

        /* 分类选择样式 */
        .category-select,
        .priority-select {
            padding: 8px 12px;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
            outline: none;
            transition: border-color 0.2s ease;
        }

        /* 截止日期输入框样式 */
        .deadline-input {
            padding: 8px 12px;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
            outline: none;
            transition: border-color 0.2s ease;
        }
        
        /* 选择控件聚焦效果 */
        .category-select:focus,
        .priority-select:focus,
        .deadline-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* 任务项内的分类标签样式 */
        .category-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            color: white;
            margin-right: 8px;
            background-color: var(--category-color);
        }

        /* 任务项内的优先级标识样式 */
        .priority-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        /* 高优先级样式 */
        .priority-high {
            background-color: #FF4D4F;
        }

        /* 中优先级样式 */
        .priority-medium {
            background-color: #FAAD14;
        }

        /* 低优先级样式 */
        .priority-low {
            background-color: #8C8C8C;
        }

        /* 任务内容和标识容器 */
        .task-main {
            display: flex;
            align-items: center;
            flex: 1;
            margin-right: 16px;
        }

        /* 响应式设计：适配手机屏幕（宽度375px） */
        @media (max-width: 375px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 24px;
                margin-bottom: 20px;
            }

            .input-area {
                flex-direction: column;
            }

            .task-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .task-content {
                margin-right: 0;
            }

            .task-buttons {
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <!-- 主容器，所有内容居中显示 -->
    <div class="container">
        <!-- 页面标题 -->
        <h1>我的待办清单</h1>

        <!-- 统计区域 -->
        <div class="stats-area">
            <h2>本周任务统计</h2>
            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-title">本周创建任务</div>
                    <div class="stat-value" id="weeklyCreated">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">本周完成任务</div>
                    <div class="stat-value" id="weeklyCompleted">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">完成率</div>
                    <div class="stat-value" id="completionRate">0%</div>
                </div>
            </div>
            <div class="chart-area">
                <canvas id="weeklyChart" width="400" height="200"></canvas>
            </div>
        </div>
        
        <!-- 搜索区域 -->
        <div class="search-area">
            <input 
                type="text" 
                class="search-input" 
                placeholder="搜索任务..."
                id="searchInput"
            >
        </div>

        <!-- 分类筛选区域 -->
        <div class="filter-area">
            <div class="filter-label">分类筛选：</div>
            <div class="filter-options">
                <button type="button" class="filter-btn active" data-category="all">全部</button>
                <button type="button" class="filter-btn" data-category="工作" style="--category-color: #3b82f6;">工作</button>
                <button type="button" class="filter-btn" data-category="生活" style="--category-color: #10b981;">生活</button>
                <button type="button" class="filter-btn" data-category="学习" style="--category-color: #f97316;">学习</button>
            </div>
        </div>

        <!-- 输入区域：用于添加新任务 -->
        <div class="input-area">
            <div class="input-container">
                <input 
                    type="text" 
                    class="task-input" 
                    placeholder="输入新任务..."
                >
            </div>
            
            <!-- 分类、优先级和截止日期选择 -->
            <div class="task-options">
                <div class="option-group">
                    <label for="categorySelect">分类：</label>
                    <select id="categorySelect" class="category-select">
                        <option value="工作">工作</option>
                        <option value="生活">生活</option>
                        <option value="学习">学习</option>
                    </select>
                </div>
                
                <div class="option-group">
                    <label for="prioritySelect">优先级：</label>
                    <select id="prioritySelect" class="priority-select">
                        <option value="低">低</option>
                        <option value="中" selected>中</option>
                        <option value="高">高</option>
                    </select>
                </div>
                
                <div class="option-group">
                    <label for="deadlineDate">截止日期：</label>
                    <input type="date" id="deadlineDate" class="deadline-input">
                    <input type="time" id="deadlineTime" class="deadline-input">
                </div>
                
                <button type="button" class="add-btn">添加</button>
            </div>
            
            <div class="char-count" id="charCount">0/100</div>
        </div>

        <!-- 任务列表区域 -->
        <div class="task-list"></div>
        
        <!-- 功能按钮区域 -->
            <div class="function-buttons">
                <!-- 导出功能 -->
                <div class="option-group export-group">
                    <label for="exportFormat">导出格式：</label>
                    <select id="exportFormat" class="export-select">
                        <option value="csv">CSV</option>
                        <option value="excel">Excel</option>
                    </select>
                    <button type="button" class="export-btn">导出任务</button>
                    <!-- 导出进度提示 -->
                    <div class="export-progress" id="exportProgress" style="display: none; margin-left: 10px; font-size: 14px; color: #6b7280;"></div>
                </div>
                
                <!-- 清空已完成任务按钮 -->
                <div class="clear-completed">
                    <button type="button" class="clear-btn">清空已完成</button>
                </div>
            </div>
    </div>

    <script>
        // 等待页面完全加载后执行代码
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const taskInput = document.querySelector('.task-input'); // 任务输入框
            const addBtn = document.querySelector('.add-btn'); // 添加按钮
            const taskList = document.querySelector('.task-list'); // 任务列表
            const clearBtn = document.querySelector('.clear-btn'); // 清空已完成按钮
            const charCount = document.getElementById('charCount'); // 字符计数显示
            const maxLength = 100; // 最大字符限制
            const searchInput = document.getElementById('searchInput'); // 搜索输入框
            const filterBtns = document.querySelectorAll('.filter-btn'); // 分类筛选按钮
            const categorySelect = document.getElementById('categorySelect'); // 分类选择器
            const prioritySelect = document.getElementById('prioritySelect'); // 优先级选择器
            const deadlineDate = document.getElementById('deadlineDate'); // 截止日期输入框
            const deadlineTime = document.getElementById('deadlineTime'); // 截止时间输入框
            const exportFormat = document.getElementById('exportFormat'); // 导出格式选择器
            const exportBtn = document.querySelector('.export-btn'); // 导出按钮
            const exportProgress = document.getElementById('exportProgress'); // 导出进度显示
            
            // 全局变量
            let currentFilter = 'all'; // 当前筛选分类
            let currentSearch = ''; // 当前搜索关键词

            // 切换到编辑模式
            function switchToEditMode(taskItem) {
                // 获取任务的当前数据
                const taskContent = taskItem.querySelector('.task-content').textContent;
                const category = taskItem.dataset.category;
                const priority = taskItem.dataset.priority;
                const deadline = taskItem.dataset.deadline;
                
                // 格式化截止日期用于编辑
                let deadlineDateStr = '';
                let deadlineTimeStr = '';
                if (deadline) {
                    const deadlineDateObj = new Date(parseInt(deadline));
                    deadlineDateStr = deadlineDateObj.toISOString().split('T')[0];
                    deadlineTimeStr = deadlineDateObj.toTimeString().split(' ')[0].slice(0, 5);
                }
                
                // 创建编辑模式的HTML结构
                const editHTML = `
                    <div class="task-edit-mode">
                        <input 
                            type="text" 
                            class="edit-input" 
                            value="${taskContent}" 
                            placeholder="输入任务内容..."
                            maxlength="100"
                            id="editContent"
                        >
                        <div class="edit-options">
                            <div class="option-group">
                                <label for="editCategory">分类：</label>
                                <select id="editCategory" class="edit-select">
                                    <option value="工作" ${category === '工作' ? 'selected' : ''}>工作</option>
                                    <option value="生活" ${category === '生活' ? 'selected' : ''}>生活</option>
                                    <option value="学习" ${category === '学习' ? 'selected' : ''}>学习</option>
                                </select>
                            </div>
                            <div class="option-group">
                                <label for="editPriority">优先级：</label>
                                <select id="editPriority" class="edit-select">
                                    <option value="低" ${priority === '低' ? 'selected' : ''}>低</option>
                                    <option value="中" ${priority === '中' ? 'selected' : ''}>中</option>
                                    <option value="高" ${priority === '高' ? 'selected' : ''}>高</option>
                                </select>
                            </div>
                            <div class="option-group">
                                <label for="editDeadlineDate">截止日期：</label>
                                <input type="date" id="editDeadlineDate" class="deadline-input" value="${deadlineDateStr}">
                                <input type="time" id="editDeadlineTime" class="deadline-input" value="${deadlineTimeStr}">
                            </div>
                        </div>
                        <div class="edit-buttons">
                            <button type="button" class="save-btn">保存</button>
                            <button type="button" class="cancel-edit-btn">取消</button>
                        </div>
                    </div>
                `;
                
                // 保存原有的HTML结构，用于取消编辑时恢复
                taskItem.dataset.originalHtml = taskItem.innerHTML;
                
                // 切换到编辑模式
                taskItem.innerHTML = editHTML;
                
                // 为保存和取消按钮添加事件监听器
                const saveBtn = taskItem.querySelector('.save-btn');
                const cancelBtn = taskItem.querySelector('.cancel-edit-btn');
                
                // 保存按钮点击事件
                saveBtn.addEventListener('click', function() {
                    saveEdit(taskItem);
                });
                
                // 取消按钮点击事件
                cancelBtn.addEventListener('click', function() {
                    cancelEdit(taskItem);
                });
            }
            
            // 保存编辑
            function saveEdit(taskItem) {
                // 获取编辑后的数据
                const editInput = taskItem.querySelector('.edit-input');
                const newContent = editInput.value.trim();
                const newCategory = taskItem.querySelector('#editCategory').value;
                const newPriority = taskItem.querySelector('#editPriority').value;
                const newDeadlineDate = taskItem.querySelector('#editDeadlineDate').value;
                const newDeadlineTime = taskItem.querySelector('#editDeadlineTime').value;
                
                // 检查输入是否为空
                if (newContent !== '') {
                    // 处理截止日期
                    let deadline = '';
                    let deadlineDisplay = '';
                    let isOverdue = false;
                    if (newDeadlineDate && newDeadlineTime) {
                        deadline = new Date(`${newDeadlineDate}T${newDeadlineTime}`).getTime().toString();
                        const deadlineDateObj = new Date(parseInt(deadline));
                        deadlineDisplay = deadlineDateObj.toLocaleString('zh-CN');
                        isOverdue = parseInt(deadline) < Date.now();
                    }
                    
                    // 获取分类颜色
                    const categoryColor = getCategoryColor(newCategory);
                    // 获取优先级样式类名
                    const priorityClass = getPriorityClass(newPriority);
                    // 检查任务是否已完成
                    const completed = taskItem.classList.contains('completed');
                    
                    // 创建更新后的任务HTML
                    let taskHTML;
                    if (completed) {
                        taskHTML = `
                            <div class="task-main">
                                <div class="priority-indicator ${priorityClass}"></div>
                                <div class="category-tag clickable" style="background-color: ${categoryColor}; cursor: pointer;" data-category="${newCategory}">${newCategory}</div>
                                <div class="task-content" style="text-decoration: line-through; color: #9ca3af;">${newContent}</div>
                                ${deadline ? `<span class="deadline-display ${isOverdue ? 'overdue' : ''}">截止：${deadlineDisplay}</span>` : ''}
                            </div>
                            <div class="task-buttons">
                                <button type="button" class="edit-btn">编辑</button>
                                <button type="button" class="complete-btn">取消</button>
                                <button type="button" class="delete-btn">删除</button>
                            </div>
                        `;
                    } else {
                        taskHTML = `
                            <div class="task-main">
                                <div class="priority-indicator ${priorityClass}"></div>
                                <div class="category-tag clickable" style="background-color: ${categoryColor}; cursor: pointer;" data-category="${newCategory}">${newCategory}</div>
                                <div class="task-content">${newContent}</div>
                                ${deadline ? `<span class="deadline-display ${isOverdue ? 'overdue' : ''}">截止：${deadlineDisplay}</span>` : ''}
                            </div>
                            <div class="task-buttons">
                                <button type="button" class="edit-btn">编辑</button>
                                <button type="button" class="complete-btn">完成</button>
                                <button type="button" class="delete-btn">删除</button>
                            </div>
                        `;
                    }
                    
                    // 更新任务HTML
                    taskItem.innerHTML = taskHTML;
                    
                    // 更新任务数据属性
                    taskItem.dataset.category = newCategory;
                    taskItem.dataset.priority = newPriority;
                    taskItem.dataset.deadline = deadline;
                    
                    // 更新过期状态
                    if (isOverdue) {
                        taskItem.classList.add('overdue');
                    } else {
                        taskItem.classList.remove('overdue');
                    }
                    
                    // 重新添加事件监听器
                    addButtonListeners();
                    
                    // 排序任务
                    sortTasks();
                    
                    // 应用筛选
                    applyFilters();
                    
                    // 保存到localStorage
                    saveTodoList();
                }
            }
            
            // 取消编辑
            function cancelEdit(taskItem) {
                // 恢复原有的HTML结构
                taskItem.innerHTML = taskItem.dataset.originalHtml;
                
                // 重新添加事件监听器
                addButtonListeners();
            }
            
            // 为分类标签添加点击事件监听器的函数
            function addCategoryTagListeners() {
                // 获取所有可点击的分类标签
                const categoryTags = document.querySelectorAll('.category-tag.clickable');
                
                // 遍历所有分类标签，添加点击事件监听器
                categoryTags.forEach(function(tag) {
                    tag.addEventListener('click', function() {
                        // 获取标签对应的分类
                        const category = this.dataset.category;
                        // 找到对应的筛选按钮
                        const correspondingBtn = document.querySelector(`.filter-btn[data-category="${category}"]`);
                        // 如果找到对应的按钮，模拟点击
                        if (correspondingBtn) {
                            correspondingBtn.click();
                        }
                    });
                });
            }
            
            // 为所有按钮添加点击事件监听器的函数
            function addButtonListeners() {
                // 获取所有删除按钮
                const deleteBtns = document.querySelectorAll('.delete-btn');
                
                // 遍历所有删除按钮，添加点击事件监听器
                deleteBtns.forEach(function(deleteBtn) {
                    // 移除可能存在的旧事件监听器，避免重复添加
                    deleteBtn.removeEventListener('click', handleDelete);
                    // 添加新的点击事件监听器
                    deleteBtn.addEventListener('click', handleDelete);
                });
                
                // 获取所有完成按钮
                const completeBtns = document.querySelectorAll('.complete-btn');
                
                // 遍历所有完成按钮，添加点击事件监听器
                completeBtns.forEach(function(completeBtn) {
                    // 移除可能存在的旧事件监听器，避免重复添加
                    completeBtn.removeEventListener('click', handleComplete);
                    // 添加新的点击事件监听器
                    completeBtn.addEventListener('click', handleComplete);
                });
                
                // 获取所有编辑按钮
                const editBtns = document.querySelectorAll('.edit-btn');
                
                // 遍历所有编辑按钮，添加点击事件监听器
                editBtns.forEach(function(editBtn) {
                    editBtn.addEventListener('click', function() {
                        // 获取当前编辑按钮所在的任务项
                        const taskItem = this.closest('.task-item');
                        // 切换到编辑模式
                        switchToEditMode(taskItem);
                    });
                });
                
                // 为分类标签添加点击事件监听器
                addCategoryTagListeners();
            }
            
            // 删除任务的处理函数
            function handleDelete() {
                // 获取当前删除按钮所在的任务项
                const taskItem = this.closest('.task-item');
                // 删除该任务项
                taskItem.remove();
                
                // 保存任务列表到localStorage
                saveTodoList();
            }
            
            // 更新清空已完成按钮的显示状态
            function updateClearButtonVisibility() {
                // 获取所有已完成的任务项
                const completedTasks = document.querySelectorAll('.task-item.completed');
                
                // 如果有已完成任务，显示清空按钮；否则隐藏
                if (completedTasks.length > 0) {
                    clearBtn.classList.remove('hidden');
                } else {
                    clearBtn.classList.add('hidden');
                }
            }
            
            // 清空已完成任务的处理函数
            function handleClearCompleted() {
                // 获取所有已完成的任务项
                const completedTasks = document.querySelectorAll('.task-item.completed');
                
                // 遍历所有已完成任务项并删除
                completedTasks.forEach(function(taskItem) {
                    taskItem.remove();
                });
                
                // 更新清空已完成按钮的显示状态
                updateClearButtonVisibility();
                
                // 保存任务列表到localStorage
                saveTodoList();
            }
            
            // 标记/取消完成任务的处理函数
            function handleComplete() {
                // 获取当前完成按钮所在的任务项
                const taskItem = this.closest('.task-item');
                // 获取任务内容元素
                const taskContent = taskItem.querySelector('.task-content');
                
                // 检查任务是否已完成
                const isCompleted = taskItem.classList.contains('completed');
                
                if (isCompleted) {
                    // 取消完成状态
                    taskItem.classList.remove('completed');
                    // 移除删除线和灰色文字样式
                    taskContent.style.textDecoration = 'none';
                    taskContent.style.color = '#333';
                    // 按钮文字变回"完成"
                    this.textContent = '完成';
                    // 将任务项移到列表顶部
                    taskList.insertBefore(taskItem, taskList.firstChild);
                } else {
                    // 标记为已完成
                    taskItem.classList.add('completed');
                    // 添加删除线和灰色文字样式
                    taskContent.style.textDecoration = 'line-through';
                    taskContent.style.color = '#9ca3af';
                    // 按钮文字变成"取消"
                    this.textContent = '取消';
                    // 将任务项移到列表底部
                    taskList.appendChild(taskItem);
                }
                
                // 更新清空已完成按钮的显示状态
                updateClearButtonVisibility();
                
                // 保存任务列表到localStorage
                saveTodoList();
            }
            
            // 为清空已完成按钮添加点击事件监听器
            clearBtn.addEventListener('click', handleClearCompleted);
            
            // 更新字符计数显示
            function updateCharCount() {
                const currentLength = taskInput.value.length;
                charCount.textContent = `${currentLength}/${maxLength}`;
                
                // 如果超过限制，添加限制样式
                if (currentLength >= maxLength) {
                    charCount.classList.add('limit-reached');
                } else {
                    charCount.classList.remove('limit-reached');
                }
            }
            
            // 输入事件处理函数
            function handleInput() {
                let currentLength = taskInput.value.length;
                
                // 如果已经超过最大长度，截断文本
                if (currentLength > maxLength) {
                    taskInput.value = taskInput.value.substring(0, maxLength);
                    currentLength = maxLength;
                }
                
                // 更新字符计数
                updateCharCount();
            }
            
            // 为输入框添加输入事件监听器
            taskInput.addEventListener('input', handleInput);
            
            // 从localStorage读取任务列表，初始化页面
            loadTodoList();
            
            // 获取分类颜色
            function getCategoryColor(category) {
                switch(category) {
                    case '工作':
                        return '#3b82f6';
                    case '生活':
                        return '#10b981';
                    case '学习':
                        return '#f97316';
                    default:
                        return '#3b82f6';
                }
            }
            
            // 获取优先级样式类名
            function getPriorityClass(priority) {
                switch(priority) {
                    case '高':
                        return 'priority-high';
                    case '中':
                        return 'priority-medium';
                    case '低':
                        return 'priority-low';
                    default:
                        return 'priority-medium';
                }
            }
            
            // 保存任务列表到localStorage
            function saveTodoList() {
                // 获取所有任务项
                const taskItems = document.querySelectorAll('.task-item');
                // 创建任务列表数组
                const todoList = [];
                
                // 遍历所有任务项，收集任务数据
                taskItems.forEach(function(item) {
                    // 获取任务内容
                    const content = item.querySelector('.task-content').textContent;
                    // 检查任务是否已完成
                    const completed = item.classList.contains('completed');
                    // 获取任务分类
                    const category = item.dataset.category;
                    // 获取任务优先级
                    const priority = item.dataset.priority;
                    // 获取任务创建时间
                    const createdAt = item.dataset.createdAt;
                    // 获取任务截止日期
                    const deadline = item.dataset.deadline;
                    // 将任务数据添加到数组
                    todoList.push({
                        content: content,
                        completed: completed,
                        category: category,
                        priority: priority,
                        createdAt: createdAt,
                        deadline: deadline
                    });
                });
                
                // 将任务列表转换为JSON字符串，保存到localStorage
                localStorage.setItem('todoList', JSON.stringify(todoList));
            }
            
            // 从localStorage读取任务列表
            function loadTodoList() {
                // 从localStorage获取保存的任务列表JSON字符串
                const savedList = localStorage.getItem('todoList');
                
                // 如果没有保存的数据，直接返回
                if (!savedList) {
                    return;
                }
                
                // 将JSON字符串解析为JavaScript数组
                let todoList = JSON.parse(savedList);
                
                // 任务排序：按优先级从高到低，相同优先级按创建时间从新到旧
                todoList.sort(function(a, b) {
                    // 优先级权重
                    const priorityWeight = {
                        '高': 3,
                        '中': 2,
                        '低': 1
                    };
                    
                    // 按优先级排序
                    const priorityDiff = priorityWeight[b.priority || '中'] - priorityWeight[a.priority || '中'];
                    if (priorityDiff !== 0) {
                        return priorityDiff;
                    }
                    
                    // 按创建时间从新到旧排序
                    return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
                });
                
                // 清空当前任务列表
                taskList.innerHTML = '';
                
                // 遍历任务列表，创建任务项
                todoList.forEach(function(task) {
                    // 创建新的任务项元素
                    const taskItem = document.createElement('div');
                    taskItem.className = 'task-item';
                    // 设置任务数据属性
                    taskItem.dataset.category = task.category || '工作';
                    taskItem.dataset.priority = task.priority || '中';
                    taskItem.dataset.createdAt = task.createdAt || Date.now();
                    taskItem.dataset.deadline = task.deadline || '';
                    
                    // 处理截止日期
                    let deadlineDisplay = '';
                    let isOverdue = false;
                    if (task.deadline) {
                        const deadlineDateObj = new Date(parseInt(task.deadline));
                        deadlineDisplay = deadlineDateObj.toLocaleString('zh-CN');
                        isOverdue = parseInt(task.deadline) < Date.now();
                        if (isOverdue) {
                            taskItem.classList.add('overdue');
                        }
                    }
                    
                    // 获取分类颜色和优先级样式
                    const categoryColor = getCategoryColor(task.category || '工作');
                    const priorityClass = getPriorityClass(task.priority || '中');
                    
                    // 根据任务是否已完成，设置不同的HTML内容
                    if (task.completed) {
                        taskItem.classList.add('completed');
                        taskItem.innerHTML = `
                            <div class="task-main">
                                <div class="priority-indicator ${priorityClass}"></div>
                                <div class="category-tag clickable" style="background-color: ${categoryColor}; cursor: pointer;" data-category="${task.category || '工作'}">${task.category || '工作'}</div>
                                <div class="task-content" style="text-decoration: line-through; color: #9ca3af;">${task.content}</div>
                                ${task.deadline ? `<span class="deadline-display ${isOverdue ? 'overdue' : ''}">截止：${deadlineDisplay}</span>` : ''}
                            </div>
                            <div class="task-buttons">
                                <button type="button" class="edit-btn">编辑</button>
                                <button type="button" class="complete-btn">取消</button>
                                <button type="button" class="delete-btn">删除</button>
                            </div>
                        `;
                    } else {
                        taskItem.innerHTML = `
                            <div class="task-main">
                                <div class="priority-indicator ${priorityClass}"></div>
                                <div class="category-tag clickable" style="background-color: ${categoryColor}; cursor: pointer;" data-category="${task.category || '工作'}">${task.category || '工作'}</div>
                                <div class="task-content">${task.content}</div>
                                ${task.deadline ? `<span class="deadline-display ${isOverdue ? 'overdue' : ''}">截止：${deadlineDisplay}</span>` : ''}
                            </div>
                            <div class="task-buttons">
                                <button type="button" class="edit-btn">编辑</button>
                                <button type="button" class="complete-btn">完成</button>
                                <button type="button" class="delete-btn">删除</button>
                            </div>
                        `;
                    }
                    
                    // 将任务项添加到任务列表
                    taskList.appendChild(taskItem);
                });
                
                // 应用当前筛选和搜索
                applyFilters();
                // 为所有按钮添加事件监听器
                addButtonListeners();
                // 更新清空已完成按钮的显示状态
                updateClearButtonVisibility();
            }
            
            // 应用筛选和搜索
            function applyFilters() {
                const taskItems = document.querySelectorAll('.task-item');
                
                taskItems.forEach(function(item) {
                    const category = item.dataset.category;
                    const content = item.querySelector('.task-content').textContent.toLowerCase();
                    const matchesFilter = currentFilter === 'all' || category === currentFilter;
                    const matchesSearch = currentSearch === '' || content.includes(currentSearch.toLowerCase());
                    
                    if (matchesFilter && matchesSearch) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }
            
            // 任务排序函数
            function sortTasks() {
                // 获取所有任务项
                const taskItems = Array.from(document.querySelectorAll('.task-item'));
                
                // 排序：按优先级从高到低，相同优先级按创建时间从新到旧
                taskItems.sort(function(a, b) {
                    // 优先级权重
                    const priorityWeight = {
                        '高': 3,
                        '中': 2,
                        '低': 1
                    };
                    
                    // 按优先级排序
                    const priorityDiff = priorityWeight[b.dataset.priority] - priorityWeight[a.dataset.priority];
                    if (priorityDiff !== 0) {
                        return priorityDiff;
                    }
                    
                    // 按创建时间从新到旧排序
                    return new Date(b.dataset.createdAt) - new Date(a.dataset.createdAt);
                });
                
                // 清空任务列表
                taskList.innerHTML = '';
                
                // 将排序后的任务项添加回列表
                taskItems.forEach(function(item) {
                    taskList.appendChild(item);
                });
            }
            
            // 检查任务是否即将到期并发送通知
            function checkUpcomingDeadlines() {
                const taskItems = document.querySelectorAll('.task-item');
                const now = Date.now();
                const oneDayInMs = 24 * 60 * 60 * 1000;
                
                taskItems.forEach(function(item) {
                    const deadline = item.dataset.deadline;
                    if (deadline) {
                        const deadlineMs = parseInt(deadline);
                        // 检查是否在24小时内到期且尚未通知
                        if (deadlineMs > now && deadlineMs <= now + oneDayInMs && !item.dataset.notified) {
                            const taskContent = item.querySelector('.task-content').textContent;
                            // 显示通知
                            if ('Notification' in window && Notification.permission === 'granted') {
                                new Notification('任务即将到期', {
                                    body: `${taskContent} 将在24小时内到期`,
                                    icon: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0Ij48cGF0aCBkPSJNMTIgMkM2LjQ4IDIgMiA2LjQ4IDIgMTJzNC40OCAxMCAxMCAxMCAxMC00LjQ4IDEwLTEwUzE3LjUyIDIgMTIgMnptMCAxOGMtNC40MSAwLTgtMy41OS04LThzMy41OS04IDgtOCA4IDMuNTkgOCA4LTMuNTkgOCA4LTggOHptMCAxYy00LjkwNSAwLTguODgtMy45NzQtOC44OC04Ljg3NCAwLTQuOTA1IDMuOTc0LTguODc0IDguODgtOC44NzQgNC45MDUgMCA4Ljg3NCAzLjk3NCA4Ljg3NCA4Ljg3NCAwIDQuOTA1LTMuOTY5IDguODc0LTguODc0IDguODc0eiIgZmlsbD0iIzMzMyIvPjwvc3ZnPg=='
                                });
                            } else if ('Notification' in window && Notification.permission !== 'denied') {
                                // 请求通知权限
                                Notification.requestPermission().then(function(permission) {
                                    if (permission === 'granted') {
                                        new Notification('任务即将到期', {
                                            body: `${taskContent} 将在24小时内到期`,
                                            icon: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0Ij48cGF0aCBkPSJNMTIgMkM2LjQ4IDIgMiA2LjQ4IDIgMTJzNC40OCAxMCAxMCAxMCAxMC00LjQ4IDEwLTEwUzE3LjUyIDIgMTIgMnptMCAxOGMtNC40MSAwLTgtMy41OS04LThzMy41OS04IDgtOCA4IDMuNTkgOCA4LTMuNTkgOCA4LTggOHptMCAxYy00LjkwNSAwLTguODgtMy45NzQtOC44OC04Ljg3NCAwLTQuOTA1IDMuOTc0LTguODc0IDguODgtOC44NzQgNC45MDUgMCA4Ljg3NCAzLjk3NCA4Ljg3NCA4Ljg3NCAwIDQuOTA1LTMuOTY5IDguODc0LTguODc0IDguODc0eiIgZmlsbD0iIzMzMyIvPjwvc3ZnPg=='
                                        });
                                    }
                                });
                            }
                            // 标记为已通知
                            item.dataset.notified = 'true';
                        }
                    }
                });
            }
            
            // 更新过期任务状态
            function updateOverdueStatus() {
                const taskItems = document.querySelectorAll('.task-item');
                const now = Date.now();
                
                taskItems.forEach(function(item) {
                    const deadline = item.dataset.deadline;
                    if (deadline) {
                        const isOverdue = parseInt(deadline) < now;
                        if (isOverdue) {
                            item.classList.add('overdue');
                            // 更新截止日期显示样式
                            const deadlineDisplay = item.querySelector('.deadline-display');
                            if (deadlineDisplay) {
                                deadlineDisplay.classList.add('overdue');
                            }
                        } else {
                            item.classList.remove('overdue');
                            // 更新截止日期显示样式
                            const deadlineDisplay = item.querySelector('.deadline-display');
                            if (deadlineDisplay) {
                                deadlineDisplay.classList.remove('overdue');
                            }
                        }
                    }
                });
            }
            
            // 初始化字符计数
            updateCharCount();
            
            // 初始化通知权限
            if ('Notification' in window && Notification.permission !== 'denied') {
                Notification.requestPermission();
            }
            
            // 定期检查即将到期的任务（每小时检查一次）
            setInterval(checkUpcomingDeadlines, 3600000);
            
            // 定期更新过期任务状态（每分钟检查一次）
            setInterval(updateOverdueStatus, 60000);
            
            // 初始检查
            checkUpcomingDeadlines();
            updateOverdueStatus();

            // 为搜索输入框添加输入事件监听器
            searchInput.addEventListener('input', function() {
                currentSearch = this.value;
                applyFilters();
            });
            
            // 为分类筛选按钮添加点击事件监听器
            filterBtns.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    // 移除所有按钮的active类
                    filterBtns.forEach(function(b) {
                        b.classList.remove('active');
                    });
                    // 为当前按钮添加active类
                    this.classList.add('active');
                    // 更新当前筛选分类
                    currentFilter = this.dataset.category;
                    // 应用筛选
                    applyFilters();
                });
            });
            
            // 拖拽排序功能实现
            let draggedItem = null;
            let placeholder = null;
            
            // 初始化拖拽功能
            function initDragAndDrop() {
                const taskItems = document.querySelectorAll('.task-item');
                
                taskItems.forEach(function(item) {
                    // 添加拖拽事件监听器
                    item.setAttribute('draggable', 'true');
                    
                    // 拖拽开始事件
                    item.addEventListener('dragstart', function(e) {
                        draggedItem = this;
                        setTimeout(() => {
                            this.classList.add('dragging');
                        }, 0);
                    });
                    
                    // 拖拽结束事件
                    item.addEventListener('dragend', function(e) {
                        this.classList.remove('dragging');
                        if (placeholder) {
                            placeholder.remove();
                            placeholder = null;
                        }
                        // 保存拖拽后的顺序
                        saveTodoList();
                    });
                    
                    // 拖拽进入事件
                    item.addEventListener('dragenter', function(e) {
                        e.preventDefault();
                        if (this !== draggedItem && !placeholder) {
                            placeholder = document.createElement('div');
                            placeholder.className = 'task-placeholder';
                            this.parentNode.insertBefore(placeholder, this);
                        }
                    });
                    
                    // 拖拽离开事件
                    item.addEventListener('dragleave', function(e) {
                        e.preventDefault();
                        if (placeholder && e.relatedTarget && !this.contains(e.relatedTarget)) {
                            placeholder.remove();
                            placeholder = null;
                        }
                    });
                    
                    // 拖拽经过事件
                    item.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        if (this !== draggedItem) {
                            // 计算拖拽方向，决定占位符位置
                            const rect = this.getBoundingClientRect();
                            const y = e.clientY - rect.top;
                            const midpoint = rect.height / 2;
                            
                            if (y < midpoint) {
                                // 拖拽到上方，插入到当前元素之前
                                if (placeholder && placeholder.nextSibling !== this) {
                                    this.parentNode.insertBefore(placeholder, this);
                                }
                            } else {
                                // 拖拽到下方，插入到当前元素之后
                                if (placeholder && placeholder.previousSibling !== this) {
                                    this.parentNode.insertBefore(placeholder, this.nextSibling);
                                }
                            }
                        }
                    });
                    
                    // 拖拽放下事件
                    item.addEventListener('drop', function(e) {
                        e.preventDefault();
                        if (placeholder) {
                            this.parentNode.insertBefore(draggedItem, placeholder);
                            placeholder.remove();
                            placeholder = null;
                        }
                    });
                });
                
                // 为任务列表添加拖拽事件监听器
                taskList.addEventListener('dragover', function(e) {
                    e.preventDefault();
                });
                
                taskList.addEventListener('drop', function(e) {
                    e.preventDefault();
                    if (placeholder && draggedItem) {
                        this.appendChild(draggedItem);
                        placeholder.remove();
                        placeholder = null;
                    }
                });
            }
            
            // 初始化拖拽功能
            initDragAndDrop();
            
            // 数据导出功能
            
            // 将任务数据转换为导出格式
            function getTaskDataForExport() {
                const taskItems = document.querySelectorAll('.task-item');
                const taskData = [];
                
                taskItems.forEach(function(item) {
                    const content = item.querySelector('.task-content').textContent;
                    const completed = item.classList.contains('completed');
                    const category = item.dataset.category;
                    const priority = item.dataset.priority;
                    const createdAt = item.dataset.createdAt;
                    const deadline = item.dataset.deadline;
                    
                    // 格式化日期
                    const createdAtDate = new Date(parseInt(createdAt));
                    const formattedCreatedAt = createdAtDate.toLocaleString('zh-CN');
                    
                    let formattedDeadline = '';
                    if (deadline) {
                        const deadlineDate = new Date(parseInt(deadline));
                        formattedDeadline = deadlineDate.toLocaleString('zh-CN');
                    }
                    
                    taskData.push({
                        '任务标题': content,
                        '分类': category,
                        '优先级': priority,
                        '完成状态': completed ? '已完成' : '未完成',
                        '创建时间': formattedCreatedAt,
                        '截止时间': formattedDeadline
                    });
                });
                
                return taskData;
            }
            
            // 导出为CSV格式
            function exportToCSV(taskData) {
                if (taskData.length === 0) {
                    alert('没有可导出的任务数据');
                    return;
                }
                
                // CSV标题
                const headers = Object.keys(taskData[0]);
                // CSV内容
                const csvContent = [
                    headers.join(','), // 标题行
                    ...taskData.map(row => headers.map(fieldName => {
                        // 处理包含逗号、引号和换行符的字段
                        const fieldValue = row[fieldName] || '';
                        return `"${fieldValue.toString().replace(/"/g, '""')}"`;
                    }).join(','))
                ].join('\n');
                
                // 创建Blob对象
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                // 创建下载链接
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `任务列表_${new Date().toISOString().slice(0, 10)}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
            
            // 导出为Excel格式
            function exportToExcel(taskData) {
                if (taskData.length === 0) {
                    alert('没有可导出的任务数据');
                    return;
                }
                
                // 创建HTML表格
                let html = '<table border="1">';
                
                // 添加表头
                html += '<tr>';
                const headers = Object.keys(taskData[0]);
                headers.forEach(header => {
                    html += `<th>${header}</th>`;
                });
                html += '</tr>';
                
                // 添加数据行
                taskData.forEach(row => {
                    html += '<tr>';
                    headers.forEach(header => {
                        const value = row[header] || '';
                        html += `<td>${value}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</table>';
                
                // 创建Blob对象
                const blob = new Blob(['\ufeff' + html], { type: 'application/vnd.ms-excel;charset=utf-8;' });
                const link = document.createElement('a');
                
                // 创建下载链接
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `任务列表_${new Date().toISOString().slice(0, 10)}.xls`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
            
            // 显示导出进度
            function showExportProgress(message) {
                exportProgress.textContent = message;
                exportProgress.style.display = 'inline-block';
            }
            
            // 隐藏导出进度
            function hideExportProgress() {
                exportProgress.style.display = 'none';
            }
            
            // 导出任务数据
            function exportTasks() {
                const format = exportFormat.value;
                
                // 显示导出进度
                showExportProgress('正在准备导出数据...');
                
                // 模拟异步导出过程
                setTimeout(() => {
                    // 获取任务数据
                    const taskData = getTaskDataForExport();
                    
                    // 根据选择的格式导出
                    if (format === 'csv') {
                        showExportProgress('正在导出CSV文件...');
                        setTimeout(() => {
                            exportToCSV(taskData);
                            hideExportProgress();
                            // 显示完成通知
                            if ('Notification' in window && Notification.permission === 'granted') {
                                new Notification('导出完成', {
                                    body: '任务列表已成功导出为CSV格式',
                                    icon: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0Ij48cGF0aCBkPSJNMTIgMkM2LjQ4IDIgMiA2LjQ4IDIgMTJzNC40OCAxMCAxMCAxMCAxMC00LjQ4IDEwLTEwUzE3LjUyIDIgMTIgMnptMCAxOGMtNC40MSAwLTgtMy41OS04LThzMy41OS04IDgtOCA4IDMuNTkgOCA4LTMuNTkgOCA4LTggOHptMCAxYy00LjkwNSAwLTguODgtMy45NzQtOC44OC04Ljg3NCAwLTQuOTA1IDMuOTc0LTguODc0IDguODgtOC44NzQgNC45MDUgMCA4Ljg3NCAzLjk3NCA4Ljg3NCA4Ljg3NCAwIDQuOTA1LTMuOTY5IDguODc0LTguODc0IDguODc0eiIgZmlsbD0iIzMzMyIvPjwvc3ZnPg=='
                                });
                            } else {
                                alert('任务列表已成功导出为CSV格式');
                            }
                        }, 500);
                    } else if (format === 'excel') {
                        showExportProgress('正在导出Excel文件...');
                        setTimeout(() => {
                            exportToExcel(taskData);
                            hideExportProgress();
                            // 显示完成通知
                            if ('Notification' in window && Notification.permission === 'granted') {
                                new Notification('导出完成', {
                                    body: '任务列表已成功导出为Excel格式',
                                    icon: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0Ij48cGF0aCBkPSJNMTIgMkM2LjQ4IDIgMiA2LjQ4IDIgMTJzNC40OCAxMCAxMCAxMCAxMC00LjQ4IDEwLTEwUzE3LjUyIDIgMTIgMnptMCAxOGMtNC40MSAwLTgtMy41OS04LThzMy41OS04IDgtOCA4IDMuNTkgOCA4LTMuNTkgOCA4LTggOHptMCAxYy00LjkwNSAwLTguODgtMy45NzQtOC44OC04Ljg3NCAwLTQuOTA1IDMuOTc0LTguODc0IDguODgtOC44NzQgNC45MDUgMCA4Ljg3NCAzLjk3NCA4Ljg3NCA4Ljg3NCAwIDQuOTA1LTMuOTY5IDguODc0LTguODc0IDguODc0eiIgZmlsbD0iIzMzMyIvPjwvc3ZnPg=='
                                });
                            } else {
                                alert('任务列表已成功导出为Excel格式');
                            }
                        }, 500);
                    }
                }, 500);
            }
            
            // 为导出按钮添加点击事件监听器
            exportBtn.addEventListener('click', exportTasks);
            
            // 更新addButtonListeners函数，在添加新任务后重新初始化拖拽功能
            const originalAddButtonListeners = addButtonListeners;
            addButtonListeners = function() {
                originalAddButtonListeners();
                initDragAndDrop();
                // 更新统计数据
                updateWeeklyStats();
            };
            
            // 简单统计功能
            
            // 获取本周的开始和结束时间
            function getThisWeekRange() {
                const now = new Date();
                const dayOfWeek = now.getDay(); // 0是周日，1-6是周一到周六
                
                // 计算本周一的日期
                const monday = new Date(now);
                monday.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                monday.setHours(0, 0, 0, 0);
                
                // 计算本周日的日期
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                sunday.setHours(23, 59, 59, 999);
                
                return {
                    start: monday.getTime(),
                    end: sunday.getTime()
                };
            }
            
            // 更新本周统计数据
            function updateWeeklyStats() {
                const taskItems = document.querySelectorAll('.task-item');
                const weekRange = getThisWeekRange();
                
                let weeklyCreated = 0;
                let weeklyCompleted = 0;
                
                // 统计本周创建和完成的任务
                taskItems.forEach(function(item) {
                    const createdAt = parseInt(item.dataset.createdAt);
                    const completed = item.classList.contains('completed');
                    
                    // 统计本周创建的任务
                    if (createdAt >= weekRange.start && createdAt <= weekRange.end) {
                        weeklyCreated++;
                        
                        // 统计本周完成的任务
                        if (completed) {
                            weeklyCompleted++;
                        }
                    }
                });
                
                // 计算完成率
                const completionRate = weeklyCreated > 0 ? Math.round((weeklyCompleted / weeklyCreated) * 100) : 0;
                
                // 更新DOM显示
                document.getElementById('weeklyCreated').textContent = weeklyCreated;
                document.getElementById('weeklyCompleted').textContent = weeklyCompleted;
                document.getElementById('completionRate').textContent = `${completionRate}%`;
                
                // 绘制周统计图表
                drawWeeklyChart(weeklyCreated, weeklyCompleted, completionRate);
            }
            
            // 绘制周统计图表
            function drawWeeklyChart(created, completed, rate) {
                const canvas = document.getElementById('weeklyChart');
                const ctx = canvas.getContext('2d');
                
                // 清空画布
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // 计算尺寸
                const width = canvas.width;
                const height = canvas.height;
                const centerX = width / 2;
                const centerY = height / 2;
                const radius = Math.min(width, height) / 3;
                
                // 绘制背景圆
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                ctx.fillStyle = '#f1f5f9';
                ctx.fill();
                
                // 绘制完成率扇形
                const endAngle = (rate / 100) * Math.PI * 2 - Math.PI / 2;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, -Math.PI / 2, endAngle);
                ctx.closePath();
                ctx.fillStyle = '#3b82f6';
                ctx.fill();
                
                // 绘制中心圆
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius * 0.7, 0, Math.PI * 2);
                ctx.fillStyle = 'white';
                ctx.fill();
                ctx.strokeStyle = '#e2e8f0';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // 绘制完成率文字
                ctx.font = 'bold 36px Arial';
                ctx.fillStyle = '#333';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(`${rate}%`, centerX, centerY);
                
                // 绘制图例
                const legendX = centerX;
                const legendY = centerY + radius + 20;
                
                // 创建任务数
                ctx.font = '14px Arial';
                ctx.fillStyle = '#6b7280';
                ctx.fillText(`创建: ${created} | 完成: ${completed}`, legendX, legendY);
            }
            
            // 初始化统计数据
            updateWeeklyStats();
            
            // 在handleClearCompleted函数中添加统计更新
            const originalHandleClearCompleted = handleClearCompleted;
            handleClearCompleted = function() {
                originalHandleClearCompleted.apply(this, arguments);
                // 更新统计数据
                updateWeeklyStats();
            };
            
            // 在handleDelete函数中添加统计更新
            const originalHandleDelete = handleDelete;
            handleDelete = function() {
                originalHandleDelete.apply(this, arguments);
                // 更新统计数据
                updateWeeklyStats();
            };
            
            // 为添加按钮添加点击事件监听器
            addBtn.addEventListener('click', function() {
                // 获取输入框的值，并去除首尾空格
                const taskText = taskInput.value.trim();

                // 检查输入是否为空
                if (taskText !== '') {
                    // 获取选择的分类
                    const category = categorySelect.value;
                    // 获取选择的优先级
                    const priority = prioritySelect.value;
                    // 获取当前时间作为创建时间
                    const createdAt = Date.now().toString();
                    // 获取分类颜色
                    const categoryColor = getCategoryColor(category);
                    // 获取优先级样式类名
                    const priorityClass = getPriorityClass(priority);
                    
                    // 处理截止日期
                    const deadlineDate = document.getElementById('deadlineDate').value;
                    const deadlineTime = document.getElementById('deadlineTime').value;
                    let deadline = '';
                    let deadlineDisplay = '';
                    let isOverdue = false;
                    if (deadlineDate && deadlineTime) {
                        deadline = new Date(`${deadlineDate}T${deadlineTime}`).getTime().toString();
                        const deadlineDateObj = new Date(parseInt(deadline));
                        deadlineDisplay = deadlineDateObj.toLocaleString('zh-CN');
                        isOverdue = parseInt(deadline) < Date.now();
                    }
                    
                    // 创建新的任务项元素
                    const taskItem = document.createElement('div');
                    taskItem.className = 'task-item';
                    // 设置任务数据属性
                    taskItem.dataset.category = category;
                    taskItem.dataset.priority = priority;
                    taskItem.dataset.createdAt = createdAt;
                    taskItem.dataset.deadline = deadline;
                    
                    // 如果任务已过期，添加过期样式
                    if (isOverdue) {
                        taskItem.classList.add('overdue');
                    }

                    // 设置任务项的HTML内容
                    taskItem.innerHTML = `
                        <div class="task-main">
                            <div class="priority-indicator ${priorityClass}"></div>
                            <div class="category-tag clickable" style="background-color: ${categoryColor}; cursor: pointer;" data-category="${category}">${category}</div>
                            <div class="task-content">${taskText}</div>
                            ${deadline ? `<span class="deadline-display ${isOverdue ? 'overdue' : ''}">截止：${deadlineDisplay}</span>` : ''}
                        </div>
                        <div class="task-buttons">
                            <button type="button" class="edit-btn">编辑</button>
                            <button type="button" class="complete-btn">完成</button>
                            <button type="button" class="delete-btn">删除</button>
                        </div>
                    `;

                    // 将新任务项添加到任务列表
                    taskList.appendChild(taskItem);
                    
                    // 对任务进行排序
                    sortTasks();
                    
                    // 应用筛选和搜索
                    applyFilters();

                    // 为所有按钮重新添加事件监听器，包括新添加的任务项
                    addButtonListeners();

                    // 清空输入框
                    taskInput.value = '';
                    
                    // 重置分类、优先级和截止日期选择
                    categorySelect.value = '工作';
                    prioritySelect.value = '中';
                    document.getElementById('deadlineDate').value = '';
                    document.getElementById('deadlineTime').value = '';
                    
                    // 更新字符计数
                    updateCharCount();
                    
                    // 保存任务列表到localStorage
                    saveTodoList();
                    
                    // 更新统计数据
                    updateWeeklyStats();
                }
            });
        });
    </script>
</body>
</html>